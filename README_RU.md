# Сервис оркестровки LLM

Сервис оркестровки LLM - это веб-приложение на основе FastAPI, предназначенное для координации и управления задачами с использованием больших языковых моделей (LLM). Сервис предоставляет REST API для создания, управления и мониторинга задач LLM с возможностями асинхронной обработки с использованием Celery и Redis.

## Особенности

- Аутентификация и авторизация пользователей (на основе JWT)
- Управление задачами для операций LLM
- Асинхронная обработка задач с помощью Celery и Redis
- Интеграция с базой данных PostgreSQL через SQLAlchemy
- Поддержка контейнеризации Docker
- Дизайн RESTful API
- Конечные точки админки для управления пользователями и задачами
- Веб-интерфейс админки для удобного управления системой
- Автоматическое создание администратора

## Структура проекта

```
├── app/
│   ├── __init__.py
│   ├── main.py              # Основное приложение FastAPI
│   ├── api/
│   │   ├── __init__.py
│   │   ├── deps.py          # Зависимости для конечных точек API
│   │   ├── endpoints/
│   │   │   ├── __init__.py
│   │   │   ├── tasks.py     # Конечные точки, связанные с задачами
│   │   │   ├── users.py     # Конечные точки управления пользователями
│   │   │   ├── auth.py      # Конечные точки аутентификации
│   │   │   └── admin.py     # Административные конечные точки
│   ├── core/
│   │   ├── __init__.py
│   │   ├── config.py        # Настройки приложения
│   │   ├── security.py      # JWT и хеширование паролей
│   │   └── startup.py       # Логика запуска приложения
│   ├── db/
│   │   ├── __init__.py
│   │   ├── session.py       # Настройка сессии базы данных
│   │   └── models.py        # Модели базы данных
│   ├── schemas/
│   │   ├── tasks.py         # Схемы Pydantic для задач
│   │   └── users.py         # Схемы Pydantic для пользователей
│   ├── services/
│   │   ├── __init__.py
│   │   └── llm_service.py   # Логика взаимодействия с LLM
│   └── tasks/
│       ├── __init__.py
│       └── celery_worker.py # Работники Celery
├── ui/
│   └── admin/               # Админ-панель на Next.js
├── alembic/                 # Миграции базы данных
│   ├── versions/            # Скрипты миграции
│   ├── env.py               # Конфигурация среды Alembic
│   └── script.py.mako       # Шаблон скрипта миграции
├── .env.example             # Пример переменных окружения
├── alembic.ini              # Конфигурация Alembic
├── Dockerfile               # Конфигурация Docker
├── docker-compose.yml       # Конфигурация Docker Compose
└── requirements.txt         # Зависимости Python
```

## Предварительные требования

- Python 3.8+
- Node.js 18+
- PostgreSQL
- Redis
- Docker (опционально, для контейнеризации)

## Установка

1. Клонируйте репозиторий:
   ```bash
   git clone <repository-url>
   cd llm-orchestra-service
   ```

2. Создайте виртуальное окружение:
   ```bash
   python -m venv venv
   source venv/bin/activate  # В Windows: venv\Scripts\activate
   ```

3. Установите зависимости Python:
   ```bash
   pip install -r requirements.txt
   ```

4. Установите зависимости UI:
   ```bash
   cd ui/admin
   npm install  # или pnpm install
   ```

5. Настройте переменные окружения:
   ```bash
   cp .env.example .env
   cp ui/admin/.env.example ui/admin/.env
   ```
   Отредактируйте файлы `.env` с вашими фактическими значениями конфигурации.

## Настройка базы данных

1. Убедитесь, что PostgreSQL запущен, и создайте базу данных:
   ```bash
   createdb llm_orchestra
   ```

2. Обновите файл `alembic.ini` строкой подключения к базе данных:
   ```
   sqlalchemy.url = postgresql://username:password@localhost/llm_orchestra
   ```

3. Запустите миграции Alembic:
   ```bash
   alembic upgrade head
   ```

## Запуск приложения

### Режим разработки

1. Запустите сервер FastAPI:
   ```bash
   uvicorn app.main:app --reload
   ```

2. Запустите работника Celery (в отдельном терминале):
   ```bash
   celery -A app.tasks.celery_worker.celery_app worker --loglevel=info
   ```

3. (Опционально) Запустите планировщик Celery beat для периодических задач:
   ```bash
   celery -A app.tasks.celery_worker.celery_app beat --loglevel=info
   ```

4. Запустите админ-панель (в отдельном терминале):
   ```bash
   cd ui/admin
   npm run dev  # или pnpm dev
   ```

### Использование Docker

1. Соберите и запустите все сервисы:
   ```bash
   docker-compose up --build
   ```

2. Сервисы будут доступны по адресам:
   - API: `http://localhost:8000`
   - Админ-панель: `http://localhost:3000`
   - База данных: `http://localhost:5432`
   - Redis: `http://localhost:6379`

## Документация API

- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

## Административные конечные точки

Сервис включает в себя полный набор административных конечных точек для управления пользователями и мониторинга задач:

### Аутентификация
- `POST /token` - Получение токена доступа с именем пользователя и паролем

### Управление пользователями
- `GET /users/me` - Получение информации о текущем пользователе
- `GET /admin/users` - Получить всех пользователей (только для администратора)
- `POST /admin/users` - Создать нового пользователя (только для администратора)
- `PUT /admin/users/{user_id}` - Обновить данные пользователя (только для администратора)
- `DELETE /admin/users/{user_id}` - Удалить пользователя (только для администратора)

### Мониторинг задач
- `GET /admin/tasks/all` - Получить все задачи в системе (только для администратора)
- `GET /admin/tasks/{task_id}` - Получить детали конкретной задачи (только для администратора)

### Статистика и метрики
- `GET /admin/stats/tasks/by_status` - Получить количество задач по статусам (только для администратора)
- `GET /admin/stats/tasks/by_type` - Получить количество задач по типам (только для администратора)

## Админ-панель

Проект включает веб-интерфейс админ-панели, построенный на Next.js, который предоставляет удобный интерфейс для:

- Управления пользователями (создание, обновление, удаление)
- Мониторинга задач (просмотр статуса, деталей)
- Просмотра системной статистики и метрик
- Настройки параметров системы

Интерфейс использует аутентификацию на основе JWT, которая интегрирована с API бэкенда. При первом входе используйте учетные данные администратора, настроенные в переменных окружения.

## Тестирование аутентификации

Для тестирования процесса аутентификации:

1. Запустите приложение в режиме разработки или с помощью Docker
2. Перейдите по адресу `http://localhost:3000` для доступа к админ-панели
3. Войдите в систему с учетными данными администратора (по умолчанию: имя пользователя `admin`, пароль `admin`)
4. Если вам нужно протестировать аутентификацию программно, вы можете использовать конечную точку `/token` напрямую

## Использование

1. При первом запуске автоматически создается администратор с учетными данными из переменных окружения
2. Перейдите по адресу `http://localhost:3000` для доступа к админ-панели
3. Войдите в систему с учетными данными администратора
4. Используйте панель администратора для управления пользователями и мониторинга задач
5. При необходимости создайте дополнительных пользователей через интерфейс администратора

## Переменные окружения

- `DATABASE_URL`: Строка подключения к базе данных PostgreSQL
- `SECRET_KEY`: Секретный ключ для генерации токенов JWT
- `ALGORITHM`: Алгоритм кодирования токенов JWT
- `ACCESS_TOKEN_EXPIRE_MINUTES`: Время истечения токена
- `CELERY_BROKER_URL`: URL Redis для брокера Celery
- `CELERY_RESULT_BACKEND`: URL Redis для результатов Celery
- `OPENAI_API_KEY`: API-ключ OpenAI для доступа к LLM
- `ADMIN_USERNAME`: Имя пользователя для администратора по умолчанию (по умолчанию: admin)
- `ADMIN_PASSWORD`: Пароль для администратора по умолчанию (по умолчанию: admin)
- `NEXT_PUBLIC_API_URL`: URL API для админ-панели (в .env файле UI)

## Распространенные проблемы и их решения

1. **Проблемы с подключением к базе данных**: Убедитесь, что PostgreSQL запущен и строка подключения в `.env` корректна.

2. **Проблемы с подключением к Redis**: Убедитесь, что Redis запущен на указанном порту (по умолчанию 6379).

3. **Отсутствующие зависимости**: Если вы сталкиваетесь с ошибками импорта, убедитесь, что все зависимости из `requirements.txt` установлены.

4. **Миграции Alembic**: Если вы изменяете модели базы данных, сгенерируйте новые миграции:
   ```bash
   alembic revision --autogenerate -m "Описание изменений"
   alembic upgrade head
   ```

## Документация на разных языках

- [English](README.md)
- [Русский](README_RU.md)

## Вклад в проект

1. Форкните репозиторий
2. Создайте ветку для новой функции
3. Зафиксируйте свои изменения
4. Отправьте изменения в вашу ветку
5. Создайте pull request

## Лицензия

Этот проект лицензирован по лицензии MIT.